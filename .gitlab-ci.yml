---
image: "centos:6.7"

before_script:
  - rpm -ivh http://download.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm
  - yum -y --enablerepo=epel-testing install ansible initscripts
  - ansible --version
  - printf '[defaults]\nroles_path=../' > ansible.cfg

test:
  script:
    # Basic role syntax check
    - ansible-playbook tests/gitlab-ci-test.yml -i tests/inventory --syntax-check

    # Run the first time
    - ansible-playbook tests/gitlab-ci-test.yml -i tests/inventory -c local -b

    # Run again and expect no changes
    - >
      ansible-playbook tests/gitlab-ci-test.yml -i tests/inventory -c local -b
      | grep -q 'changed=0.*failed=0'
      && (echo 'Idempotence test: pass' && exit 0)
      || (echo 'Idempotence test: fail' && exit 1)
